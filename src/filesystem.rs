use crate::{alloc, applications::{assembly, basic, femc}, info, print, println, string::BigString, vec::{BigVec, FileVec}, warnln};

use lazy_static::lazy_static;
use spin::Mutex;

pub struct FileSystem {
    files: FileVec,
    flow: i32
}
impl FileSystem {
    fn _get_item_name(&self, id: u32) -> [u8; 20] {
        self.files.iter()[id as usize].3
    }

    fn print_path(&self, id: u32) {
        let file = self.files.iter()[id as usize];
        if file.1 != -1 {
            self.print_path(file.1 as u32);
            info!("/");
        }
        for byte in file.3 {
            if byte == 0 { break; }
            info!("{}", byte as char);
        }
    }

    pub fn create_file(&mut self, parent: i32, filename: [u8; 20], filetype: u8, data: &str) {
        let data_bytes = data.bytes();

        let address = alloc::alloc(data.bytes().len());

        let mut index = 0;
        for i in data_bytes {
            if address.0 + index > address.1 {
                break;
            }
            alloc::write_byte(address.0 + index, i as usize);
            index += 8;
        }

        self.files.add((self.files.len() as u32, parent, (address.0, address.1, index / 8), filename, filetype));

        print!("Created a new file with path ");
        info!("/");
        self.print_path(self.files.len() as u32 - 1);
        print!("\n");
    }

    pub fn set_flow(&mut self, flow: i32) {
        self.flow = flow;
    }

    // this being a list of 20 is the max amount of files that will be returned, why 20? sounds good to me tbh :3
    pub fn get_file_from_parent(&self, parent: i32) -> [(u32, i32, (usize, usize, usize), [u8; 20], u8); 20] {
        let mut files_returning = [(0, -1, (0, 1, 0), [1; 20], 0); 20];
        let mut files_returning_len = 0;
        for file in self.files.iter() {
            if file.1 == parent && files_returning_len < 20 {
                files_returning[files_returning_len] = file;
                files_returning_len += 1;
            }
        }
        files_returning
    }

    pub fn get_file_from_current_parent(&self) -> [(u32, i32, (usize, usize, usize), [u8; 20], u8); 20] {
        self.get_file_from_parent(self.flow)
    }
}

lazy_static! {
    pub static ref FILESYSTEM: Mutex<FileSystem> = Mutex::new(FileSystem {
        files: FileVec::new(),
        flow: 1
    });
}

pub fn print_current_dir_files() {
    let files_found = FILESYSTEM.lock().get_file_from_current_parent();
    for file in files_found {
        if file.1 == -1 { continue; }
        for char_byte in file.3 {
            if char_byte == 0 { break; }
            print!("{}", char_byte as char);
        }
        print!("\n");
    }
}

pub fn change_flow(name: [u8; 20]) {
    let files = {
        FILESYSTEM.lock().get_file_from_current_parent()
    };
    for file in files {
        if file.3 == name {
            FILESYSTEM.lock().set_flow(file.0 as i32);
        }
    }
}

pub fn find_file(name: [u8; 20]) -> (u32, i32, (usize, usize, usize), [u8; 20], u8) {
    let files = {
        FILESYSTEM.lock().get_file_from_current_parent()
    };
    for file in files {
        let mut file_name: [u8; 20] = [0; 20];
        for byte in file.3.iter().enumerate() {
            if *byte.1 == 61 { break; }
            file_name[byte.0] = *byte.1;
        }
        if name == file_name {
            return file
        }
    }
    println!("This file doesn't seem to exist :c");
    return (0, 0, (0, 0, 0), [0; 20], 0)
}

pub fn create_file(parent: i32, filename: &str, filetype: &str, data: &str) {
    let mut filename_bytes = [0; 20];
    let mut filename_bytes_len = 0;

    let file_type = {
        match filetype {
            "a" => 1,   // assembly
            "b" => 2,   // basic
            "fc" => 3,  // FemC
            _ => 0      // Flow
        }
    };

    let is_flow = filetype.bytes().len() == 0;

    let filename_parsed = filename.bytes();
    for byte in filename_parsed {
        filename_bytes[filename_bytes_len] = byte;
        filename_bytes_len += 1;
    }

    if !is_flow {
        filename_bytes[filename_bytes_len] = 61;
        filename_bytes_len += 1;
        let filetype_parsed = filetype.bytes();
        for byte in filetype_parsed {
            filename_bytes[filename_bytes_len] = byte;
            filename_bytes_len += 1;
        }
    }

    FILESYSTEM.lock().create_file(parent, filename_bytes, file_type, data);
}

pub fn read_file(name: [u8; 20]) {
    let file = find_file(name);
    let file_start = file.2.0;
    let file_size = file.2.2;

    for i in 0..file_size {
        let byte = alloc::read_byte(file_start + i * 8) as u8;
        print!("{}", byte as char);
    }
    print!("\n");
}

pub fn read_image(name: [u8; 20]) -> BigVec {
    let file = find_file(name);
    let file_start = file.2.0;
    let file_size = file.2.2;

    let mut contents = BigVec::new();

    for i in 0..file_size {
        let byte = alloc::read_byte(file_start + i * 8);
        contents.add(byte);
    }

    println!("LENGTH: {} ACTUAL: {} TEST: {}", contents.len(), file_size, contents.get(9000));

    return contents
}

pub fn run_file(name: [u8; 20]) {
    let file = find_file(name);
    let file_start = file.2.0;
    let file_size = file.2.2;
    let file_type = file.4;

    match file_type {
        1 => {
            let mut file_data: BigString = BigString::new();
            for i in 0..file_size {
                let byte = alloc::read_byte(file_start + i * 8) as u8;
                file_data.add(byte);
            }
            assembly::exec(file_data);
        }
        2 => {
            let mut file_data: [u8; 512] = [0; 512];
            for i in 0..file_size {
                if i >= 512 {
                    break;
                }
                let byte = alloc::read_byte(file_start + i * 8) as u8;
                file_data[i] = byte;
            }
            basic::exec(file_data);
        }
        3 => {
            let mut file_data: [u8; 256] = [0; 256];
            for i in 0..file_size {
                if i >= 256 {
                    break;
                }
                let byte = alloc::read_byte(file_start + i * 8) as u8;
                file_data[i] = byte;
            }
            femc::exec(file_data);
        }
        _ => warnln!("Unrecognized file type, I can't run this :C")
    }
}

pub fn install_base_os() {
    println!("Installing FemDOS");
    create_file(1, "file1", "b", "PRINT \"Hello,world\"");
    create_file(1, "python1", "fc", "print 1 + 10 * 10\nprint 10 + 10\ntest = 10\ntest2 = 20\nprint test\nprint test2");
    create_file(1, "loop_test_1", "fc", "do\nprint 10\nrepeat 10");
    create_file(1, "loop_test_2", "fc", "do\nprint 10\nrepeat 0\ndo\nprint 5\nrepeat 10");
    create_file(1, "if_test_1", "fc", "if 10 == 10\nprint 10\nend\nif 10 == 5\nprint 5\nend");
    create_file(1, "color_test_1", "fc", "color 1 1");
    create_file(1, "color_test_2", "fc", "color 11 11\nprint true\ncolor 13 13\nprint true\ncolor 15 15\nprint true\ncolor 13 13\nprint true\ncolor 11 11\nprint true\ncolor 15 0");

    create_file(1, "basic", "b", "
    PRINT \"loops\"
    PRINT \"are\"
    PRINT \"amazing\"

    DO
    PRINT TRUE
    PRINT FALSE
    LOOP
    PRINT TRUE
    ");

    create_file(1, "asm", "a", "
    section .data
    hello db \"Hello,World!\", 0
    section .text
    global _start
    _start:

    mov eax, 4
    mov ebx, 1
    mov ecx, hello
    mov edx, 13
    int 0x80

    mov eax, 1
    xor ebx, ebx
    int 0x80
    ");

    create_file(1, "smiley", "img", "005006255255255255255255255255255255255255255255255255255255000000000000000000000000000255255255000000000255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255000000000255255255000000000255255255255255255000000000255255255000000000255255255");
    create_file(1, "uwu", "img", "032032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255254254254254254254254254254254254254252252252254254254255255255254254254254254254254254254254254254254254254254254254254254254254254254255255255254254254255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255254254254255255255255255255253253253255255255255255255254254254254254254253253253252252252252252252255255255253253253251251251253253253255255255254254254254254254255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255254254254253253253255255255210210210244244244254254254255255255255255255255255255255255255253253253255255255255255255255255255254254254255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255254254254251251251255255255142142142000000000051051051255255255192192192085085085150150150130130130255255255199199199107107107229229229255255255253253253254254254255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254253253253254254254233233233011011011136136136029029029174174174105105105000000000000000000000000000213213213035035035000000000054054054253253253253253253254254254255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255251251251255255255156156156072072072255255255157157157081081081102102102100100100070070070116116116085085085071071071227227227027027027187187187255255255252252252254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254250250250254254254107107107143143143251251251207207207056056056076076076169169169126126126134134134016016016155155155255255255122122122114114114254254254250250250255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254251251251255255255085085085178178178254254254226226226060060060175175175245245245244244244207207207054054054181181181253253253174174174085085085255255255251251251254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255253253253252252252255255255074074074200200200255255255235235235063063063255255255255255255253253253255255255081081081195195195255255255199199199073073073255255255252252252253253253255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254253253253255255255069069069212212212255255255239239239062062062239239239254254254252252252253253253069069069210210210255255255212212212069069069255255255253253253254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255067067067218218218255255255239239239062062062242242242255255255253253253255255255067067067217217217255255255217217217067067067255255255254254254254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255066066066220220220255255255235235235062062062245245245254254254254254254255255255066066066220220220255255255219219219067067067255255255253253253254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255067067067220220220255255255230230230064064064250250250255255255254254254255255255065065065222222222255255255216216216067067067255255255254254254254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255067067067218218218255255255222222222065065065254254254254254254254254254255255255066066066221221221255255255211211211069069069255255255253253253254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255069069069216216216255255255214214214069069069255255255253253253253253253255255255067067067219219219255255255205205205074074074255255255252252252254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255253253253253253253255255255065065065210210210255255255201201201070070070254254254252252252254254254255255255062062062215215215255255255194194194071071071255255255252252252253253253255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254252252252255255255091091091214214214255255255200200200093093093255255255251251251253253253255255255093093093222222222255255255202202202110110110255255255252252252254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255241241241252252252255255255249249249237237237255255255254254254254254254255255255245245245253253253255255255253253253250250250255255255254254254255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255254254254255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255254254254254254254255255255254254254254254254255255255254254254254254254255255255254254254254254254255255255254254254254254254255255255254254254254254254255255255254254254255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255000000000255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255255")
}